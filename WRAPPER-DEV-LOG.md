# WRAPPER-DEV-LOG

ラッパー開発の進捗・意思決定・課題を記録するログです。日付単位で短く、決定と根拠が追跡できるように記載してください。

テンプレート：

## YYYY-MM-DD
- 背景／スコープ：
- 決定事項：
  - 
- 根拠・検討メモ：
  - 
- 未解決事項：
  - 
- 次アクション：
  - 
- リスク／課題：
  - 
- 参照リンク：
  - `README-FOR-WRAPPER.md` の該当節など

---

## 2025-08-29
- 背景／スコープ：GUI のデザインセンス（特に litera 適用時の可読性と操作性）が悪いとの指摘。「フォントが小さすぎる」「セクションタイトルが分かりにくい」を解消。
- 決定事項：
  - テーマを `litera` に固定（GUI の配色切替は不要のためセレクタを撤去）。
  - 基本フォントサイズを拡大（12ptへ）。ヘッダは 18pt 太字、セクション見出しは 14pt 太字＋プライマリ色。
  - セクション見出し直下に `ttk.Separator` を追加し視覚的に区切りを明確化。
  - `Start API`/`Stop API` ボタンを右寄せ、`Start` はプライマリ、`Stop` はデンジャー色に統一。余白・パディングも拡大。
  - Transcript テキスト領域のフォントも拡大。
  - レイアウトを2カラム（左：Server Settings＋Endpoints、右：Recorder）に再構成。ウィンドウ幅が閾値未満の場合は1カラム（Server→Endpoints→Recorder）へ自動切替。折りたたみUIを撤去し常時展開。
  - Server Settings をスクロール可能なパネルに変更（小ウィンドウでも全項目を参照可能）。
  - 右側 Recorder を `rowspan=2` で配置し、左側の2段（Server/Endpoints）と高さを揃えて右下の空白を解消。
  - Hugging Face トークンを `HfApi().whoami` で即時検証し、有効時のみ「Enable diarization」を有効化（未検証/無効時は無効）。
- 根拠・検討メモ：読みやすさと視認性、主操作の強調を最優先に再設計。litera 想定での配色一貫性を確保。
- 未解決事項：高DPI環境やLinux系テーマエンジンでの表示差異の微調整。
- 次アクション：ユーザーフィードバックに基づく余白やコントラストの微調整。必要ならアイコン／色弱対応の検討。
- リスク／課題：既存ユーザーがテーマ切替を期待していた場合の機能後退。旧設定ファイルに保存されたテーマ値は無視される（実害なし）。
- 参照リンク：`wrapper/app/gui.py`、`README-FOR-WRAPPER.md` のインターフェース節（デザイン刷新追記）。


## 2025-08-29
- 背景／スコープ：モデルダウンロード時に `tqdm_class` へ `functools.partial` を渡していたため、`'functools.partial' object has no attribute 'get_lock'` が発生。
- 決定事項：
  - `wrapper/app/model_manager.py` で `tqdm_class` には部分適用ではなく、コールバックを束縛した `hf_tqdm` のサブクラスを返すファクトリ関数を使用。
  - GUI 側の遅延実行コールバックで `except Exception as e` の `e` がスコープ外になる問題を `lambda err=e: ...` で修正。
- 根拠・検討メモ：`huggingface_hub` は `tqdm_class.get_lock()` のようにクラス属性へアクセスするため、クラスを渡す必要がある。`partial` では不足。
- 未解決事項：`huggingface_hub` の将来バージョン変更により API が変わる可能性の追随。
- 次アクション：主要モデル（small/base/large）で進捗表示と完了までの動作確認。
- リスク／課題：環境により `tqdm` 実装差異がある場合の互換性。

---

## 2025-09-24
- 背景／スコープ：UI 要素の配置整理とモダン化準備。
- 決定事項：
  - Manage models ボタンを Hugging Face Login の下へ移動。
  - Endpoints セクションをウィンドウ最下部に移動。
  - License ボタンをメインウィンドウ右上へ移動。
- 根拠・検討メモ：操作導線の整理と情報の優先度見直し。
- 未解決事項：
  - UI 全体のモダン化（デザイン刷新）方針の詳細検討。
- 次アクション：
  - 更なる UI リデザイン案の検討・実装。
- リスク／課題：
  - 既存ユーザーがボタン位置変更に戸惑う可能性。
- 参照リンク：
  - `README-FOR-WRAPPER.md` インターフェース節、`wrapper/app/gui.py`

## 2025-08-29
- 背景／スコープ：外部ネットワークからの接続有効化を GUI から簡単に行いたい。稼働中に設定変更されることで不整合が起きるのを防止したい。
- 決定事項：
  - GUI に「Allow external connections (0.0.0.0)」チェックを追加し、オン時は Back/Api の host を `0.0.0.0` に自動設定、オフで直前のローカルホストを復元。
  - サーバー稼働中はホスト/ポート、モデル、話者分離、外部接続許可、Auto-start、HF ログイン等をロック。Stop 後に解除。
- 根拠・検討メモ：bind アドレスを明示的に切替でき、操作ミスによる途中変更でのプロセス不整合を抑止するため。
- 未解決事項：`0.0.0.0` 選択時に LAN アクセス用の実 IP アドレスを GUI に併記する案（利便性向上）。
- 次アクション：LAN 向けアクセス URL のヒント表示検討（例：ローカル IP の自動表示）。
- リスク／課題：`0.0.0.0` での待受はセキュリティリスクがあるため、ユーザーのファイアウォール設定・ポート開放状況への依存が高い。
- 参照リンク：`README-FOR-WRAPPER.md`（インターフェース／設定）

---

## 2025-01-01（初期化例）
- 背景／スコープ：本リポジトリの既存コードを改変せず、`wrapper/` で機能を合成する。
- 決定事項：仕様書は `README-FOR-WRAPPER.md`、ログは本ファイルで管理。
- 根拠・検討メモ：upstream 連携のため、既存ファイルの変更は最小化が必要。
- 未解決事項：最小 CLI の要件確定。
- 次アクション：CLI 雛形の作成、主要ユースケースの列挙。
- リスク／課題：依存バージョン差異／動作環境差異。
- 参照リンク：`AGENTS.md`

---

## 2025-08-28
- 背景／スコープ：Windows 向けラッパーアプリ初期実装。GUI 自動起動と Whisper API 互換のファイル文字起こし API を追加。
- 決定事項：
  - `wrapper/cli/main.py` で `whisperlivekit.basic_server` をサブプロセス起動し、ブラウザを開く。
  - `wrapper/api/server.py` に `/v1/audio/transcriptions` エンドポイントを実装。
- 根拠・検討メモ：既存コードを変更せず WebSocket `/asr` を利用するため、ffmpeg で PCM 変換後に WebSocket へストリーム。
- 未解決事項：エラーハンドリングの詳細、設定ファイル化。
- 次アクション：設定テンプレートの整備、PyInstaller/MSIX での配布検証。
- リスク／課題：ffmpeg 未インストール環境での利用者体験、依存ライブラリのバージョン差異。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-09-14
- 背景／スコープ：Whisper モデルや話者分離モデルを GUI から指定したいとの要望。
- 決定事項：
  - ラッパー GUI に Whisper モデル、話者分離（segmentation/embedding）モデル、Hugging Face ログインボタンを追加。
  - 設定ファイルに `model`、`diarization`、`segmentation_model`、`embedding_model` を保存し、旧設定はデフォルト値で補完。
- 根拠・検討メモ：Web GUI との機能差を縮め、追加設定の永続化と既存ユーザーの移行を自動化するため。
- 未解決事項：Hugging Face トークンの更新・失効の扱い。
- 次アクション：ユーザーからのフィードバック収集と UI 改善検討。
- リスク／課題：外部コマンド失敗時のユーザー通知、モデルダウンロードに伴う初回起動の遅延。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節、設定節。

---

## 2025-09-17
- 背景／スコープ：UI のモダン化（テーマ切替、アイコンツールバー、レスポンシブレイアウト、ステータスバー）。
- 決定事項：
  - `ttkbootstrap` を導入し、ライト／ダークテーマ切替と統一スタイルを実装。選択テーマは設定に保存。
  - アイコン付きツールバーを追加し、録音開始・停止やモデル管理へのショートカットを提供。
  - サーバー設定・録音・エンドポイントの各セクションを折りたたみ可能にし、レスポンシブなレイアウトに再編。
  - モデルダウンロード進捗を常設ステータスバーとプログレスバーで表示し、モーダルダイアログを廃止。
- 根拠・検討メモ：従来 UI が古く操作しづらいとの指摘を受け、視認性と操作性を向上させるため。
- 未解決事項：アイコン素材の拡充とテーマプリセットの検証。
- 次アクション：ユーザーテストを実施し、必要な微調整を検討。
- リスク／課題：`ttkbootstrap` 依存によるサイズ増加や追加インストールの必要性。
- 参照リンク：`README-FOR-WRAPPER.md` インターフェース節。
## 2025-09-20
- 背景／スコープ：Whisper モデルだけでなく Hugging Face 上の話者分離モデルも自動ダウンロード・管理したいという要望。
- 決定事項：
  - `model_manager` を Hugging Face キャッシュベースに刷新し、Whisper/Segmentation/Embedding モデルを共通の仕組みで取得・削除。
  - GUI のモデル管理ダイアログと API 起動時の自動ダウンロード対象に話者分離モデルを追加。
  - サーバー起動時に `HUGGINGFACE_HUB_CACHE` と `HF_HOME` を設定し、ダウンロード済みモデルを再利用。
- 根拠・検討メモ：オフライン運用時でも必要モデルが揃っていれば動作させたい。利用者がGUIで管理できる方が分かりやすい。
- 未解決事項：VAD（Silero）など他モデルの統合は今後検討。
- 次アクション：MSIX オフライン計画に沿って CLI `prefetch` の実装を進める。
- リスク／課題：Hugging Face 側のキャッシュ仕様変更に追随する必要がある。
- 参照リンク：`README-FOR-WRAPPER.md` の MSIX オフライン対応節。

---

## 2025-09-22
- 背景／スコープ：MSIX 配布時にモデルを同梱せず、Hugging Face から取得したい。
- 決定事項：
  - GUI にモデル管理パネルを追加し、Whisper モデルのダウンロード進捗表示と削除を実装。
  - サーバー起動時は `--model_dir` でダウンロード済みモデルを指定し、未ダウンロードならエラーで誘導。
- 根拠・検討メモ：配布サイズを抑え、ユーザーが必要なモデルのみ取得できるようにするため。
- 未解決事項：話者分離モデル・VAD の扱い、ハッシュ検証、リトライ機構。
- 次アクション：CLI からのモデル管理機能やダウンロードエラー時の再試行を検討。
- リスク／課題：初回起動時にネットワークへアクセスできないと使用開始できない。
- 参照リンク：`README-FOR-WRAPPER.md` 13章、`wrapper/app/model_manager.py`

---

## 2025-09-23
- 背景／スコープ：Whisper モデル未取得時の手動ダウンロード手順を簡素化したい。
- 決定事項：
  - サーバー起動時に選択した Whisper モデルがローカルに無い場合、自動でダウンロードを開始し、完了後に起動するよう変更。
- 根拠・検討メモ：モデル管理ダイアログを開かなくても開始でき、初回利用時の操作を減らすため。
- 未解決事項：ダウンロード失敗時の自動リトライやネットワーク不通時のフォールバック。
- 次アクション：エラー時の再試行機構、話者分離モデルの自動ダウンロード検討。
- リスク／課題：オフライン環境では起動できない。自動ダウンロードが予期せぬ通信を発生させる可能性。
- 参照リンク：`README-FOR-WRAPPER.md` 5章・13章、`wrapper/app/gui.py`

## 2025-09-16
- 背景／スコープ：Web GUI ボタンの状態管理とライセンス表示に upstream 情報を追加。
- 決定事項：
  - サーバー起動中のみ `Open Web GUI` ボタンを有効化。
  - ライセンスウィンドウに [QuentinFuxa/WhisperLiveKit](https://github.com/QuentinFuxa/WhisperLiveKit) へのリンクとラッパーである旨の注記を追加。
  - GUI 起動時にバックエンド/API を自動起動する設定のデフォルトをオンに変更。
- 根拠・検討メモ：誤操作防止と upstream へのクレジット明示、起動直後から Web GUI を利用できるようにするため。
- 未解決事項：自動起動失敗時の通知方法。
- 次アクション：起動エラー時のリトライやエラーメッセージ整備を検討。
- リスク／課題：旧設定ファイルで `auto_start` 未設定の場合、意図せず自動起動される可能性。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節・設定節。

---

## 2025-09-15
- 背景／スコープ：指定可能なモデルを分かりやすくするため GUI の入力方法を改善。
- 決定事項：
  - Whisper モデルをプルダウン選択にし、`available_models.md` の一覧から候補を読み込む。
  - 話者分離用 `Segmentation model`・`Embedding model` に既定モデルのプルダウンを追加し、任意のモデル ID も手入力できるようにした。
- 根拠・検討メモ：公式で提供されるモデル名を明示しつつ、拡張モデルの指定も柔軟に行えるようにするため。
- 未解決事項：候補リストをオンラインから動的取得するかは未検討。
- 次アクション：利用者からの追加モデル要望を収集し、必要に応じて候補を更新。
- リスク／課題：`available_models.md` のフォーマット変更による読み込み失敗。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-08-30
- 背景／スコープ：MSIX 形式での配布を想定し、必要な追加実装とドキュメント整備を検討。
- 決定事項：
  - MSIX ビルド手順を仕様書に追記。
  - `wrapper/scripts/build_msix.ps1` を雛形として追加。
- 根拠・検討メモ：PyInstaller→makeappx→signtool のフローが一般的であり、設定移行も必要。
- 未解決事項：`AppxManifest.xml` の詳細、署名証明書の扱い。
- 次アクション：ビルドスクリプトの実装詳細と設定移行ロジックの検討。
- リスク／課題：証明書管理、MSIX パッケージの検証手間。
- 参照リンク：`README-FOR-WRAPPER.md` の MSIX パッケージング節。

---

## 2025-08-31
- 背景／スコープ：GUI からポート番号を指定し、API の起動・停止と自動起動モードを追加。
- 決定事項：
  - `wrapper/app/gui.py` にポート入力フィールドと Start/Stop ボタン、Auto-start チェックを実装。
  - `wrapper/api/server.py` が環境変数 `WRAPPER_BACKEND_HOST`/`WRAPPER_BACKEND_PORT` を参照。
- 根拠・検討メモ：環境依存値を GUI で柔軟に操作し、ユーザー操作で API を制御できるようにするため。
- 未解決事項：設定値の永続化、GUI のレイアウト改善。
- 次アクション：設定保存機構の検討と自動テストの追加。
- リスク／課題：サブプロセス管理の安定性、ポート競合時のユーザー通知。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-09-02
- 背景／スコープ：ポート自動割り当てとエンドポイント表示機能の追加。
- 決定事項：
  - GUI 起動時に空きポートを自動選択し入力欄へ表示する。
  - Backend Web UI・WebSocket `/asr`・ファイル文字起こし API の各エンドポイントを GUI に表示し、コピー用ボタンを設置する。
- 根拠・検討メモ：ポート競合の回避とエンドポイント共有の利便性向上のため。
- 未解決事項：設定値の永続化方式。
- 次アクション：設定保存機構の検討。
- リスク／課題：起動直後に他プロセスが同ポートを使用する可能性。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-09-05
- 背景／スコープ：ラッパー側 GUI に WebSocket 録音機能とエンドポイント入力欄を追加。
- 決定事項：
  - `wrapper/app/gui.py` に録音開始/停止ボタン、音量表示、タイマー、文字起こし結果の表示欄を実装。
  - WebSocket URL を編集可能にし、コピー機能を提供。
- 根拠・検討メモ：ブラウザを開かずにラッパーのみで簡易録音・確認ができるようにするため。
- 未解決事項：録音設定の永続化、依存ライブラリのバイナリ配布。
- 次アクション：録音データ保存機能の検討と設定保存方式の検討。
- リスク／課題：`sounddevice` 未インストール環境での利用者体験、WebSocket 接続エラー時のハンドリング不足。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節、実行・セットアップ節。

---

## 2025-09-06
- 背景／スコープ：Web GUI にある設定（テーマ選択）をラッパー GUI に実装し、録音文字起こし結果の保存先を指定可能にする。
- 決定事項：
  - Tkinter GUI に System/Light/Dark のテーマ選択を追加し、即時反映。
  - 文字起こし結果の保存パス入力とファイル選択ダイアログを実装し、録音終了時に自動保存。
- 根拠・検討メモ：Web GUI との機能差を埋め、録音結果の活用方法を拡張。
- 未解決事項：テーマ設定および保存先の永続化方法。
- 次アクション：設定保存機能の検討。
- リスク／課題：ダークテーマ時の ttk スタイル調整のばらつき。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節、実行・セットアップ節。

---

## 2025-09-07
- 背景／スコープ：ユーザーの要望によりテーマ切り替え機能を削除し、録音結果保存のみを維持。
- 決定事項：
  - Tkinter GUI からテーマ選択 UI と関連処理を除去。
- 根拠・検討メモ：機能過多を避け、必要最小限の録音補助に集中するため。
- 未解決事項：設定値（保存先など）の永続化方式。
- 次アクション：設定保存機能の検討。
- リスク／課題：視覚的なカスタマイズができなくなったことによる一部ユーザーの不満。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-09-09
- 背景／スコープ：Web GUI へのリンク、ライセンス表示、設定永続化の要望対応。
- 決定事項：
  - Tkinter GUI に `Open Web GUI` と `License` ボタンを追加。
  - 設定をホームディレクトリ `~/.whisperlivekit-wrapper.json` に保存・読み込み。
- 根拠・検討メモ：ブラウザを手動で開かずに Web GUI へアクセスでき、ライセンス確認と設定再利用の利便性が向上するため。
- 未解決事項：設定ファイルのバージョン管理と上位互換性の維持。
- 次アクション：設定項目の拡張時にマイグレーション手順を検討。
- リスク／課題：権限の制限された環境でホームディレクトリへの書き込みに失敗する可能性。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節、設定節。

---

## 2025-09-10
- 背景／スコープ：MSIX 配布時の権限制約を考慮し、設定ファイルの保存先を再設計。
- 決定事項：
  - `platformdirs` を用いて OS 共通のユーザー設定ディレクトリに `settings.json` を保存。
  - 旧 `~/.whisperlivekit-wrapper.json` が存在する場合は初回起動時に新ディレクトリへ自動移行。
  - 依存ライブラリを `requirements.txt` に集約。
- 根拠・検討メモ：MSIX ではホームディレクトリ書き込みが制限される可能性があり、`platformdirs` による保存が安全なため。
- 未解決事項：設定ファイルのスキーマ変更時のバージョン管理。
- 次アクション：MSIX パッケージ化手順の具体化と自動テスト整備。
- リスク／課題：`platformdirs` への依存追加によるサイズ増加、異なる OS でのパス検証。
- 参照リンク：`README-FOR-WRAPPER.md` の設定節、MSIX パッケージング節。

---

## 2025-09-11
- 背景／スコープ：GUI レイアウトの刷新とリサイズ対応、スタイル改善。
- 決定事項：
  - `wrapper/app/gui.py` をセクション分割し、`ttk.Labelframe` で整理。
  - `ttk.Style` に `clam` テーマと余白設定を適用し、視認性を改善。
  - ウィンドウサイズに合わせて各ウィジェットが拡縮するよう `grid` に weight/sticky を設定。
- 根拠・検討メモ：レイアウトが固定で操作性が悪いとの指摘があり、視認性向上が求められたため。
- 未解決事項：
  - テーマのさらなるカスタマイズや追加テーマ対応。
- 次アクション：
  - 利用者フィードバックをもとに細かな調整を検討。
- リスク／課題：
  - Tkinter のテーマが環境によって異なる表示になる可能性。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節。

---

## 2025-09-14
- 背景／スコープ：Whisper モデルや話者分離モデルを GUI から指定したいとの要望。
- 決定事項：
  - ラッパー GUI に Whisper モデル、話者分離（segmentation/embedding）モデル、Hugging Face ログインボタンを追加。
  - 設定ファイルに `model`、`diarization`、`segmentation_model`、`embedding_model` を保存し、旧設定はデフォルト値で補完。
- 根拠・検討メモ：Web GUI との機能差を縮め、追加設定の永続化と既存ユーザーの移行を自動化するため。
- 未解決事項：Hugging Face トークンの更新・失効の扱い。
- 次アクション：ユーザーからのフィードバック収集と UI 改善検討。
- リスク／課題：外部コマンド失敗時のユーザー通知、モデルダウンロードに伴う初回起動の遅延。
- 参照リンク：`README-FOR-WRAPPER.md` のインターフェース節、設定節。
